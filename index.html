<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sarmad Protocol</title>

<style>
body { background:#050505; color:#fff; font-family:sans-serif; margin:0; }
.card { background:#111; border:1px solid #222; padding:20px; margin:15px; border-radius:15px; }
button { width:100%; padding:15px; background:#d4af37; border:none; border-radius:10px; }
input { width:100%; padding:15px; margin:10px 0; background:#000; color:#fff; border:1px solid #333; border-radius:10px; }
</style>
</head>

<body>

<div id="auth" class="card">
  <h3>دخول المستثمر</h3>
  <input id="phone" placeholder="+962xxxxxxxxx">
  <div id="recaptcha"></div>
  <button onclick="sendOTP()">إرسال الرمز</button>
  <input id="otp" placeholder="OTP" style="display:none">
  <button onclick="verifyOTP()" style="display:none" id="vbtn">دخول</button>
</div>

<div id="main" style="display:none">
  <div class="card">
    <h3>رصيدك</h3>
    <h1 id="bal">0</h1>
  </div>

  <div class="card">
    <input id="txid" placeholder="TXID">
    <button onclick="sendReq()">إرسال الطلب</button>
  </div>

  <div class="card">
    <table width="100%" id="hist"></table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBVyEPs_xvz9Oryk-jpLev4ja7Sb1P6RaM",
  authDomain:"sarmad-web.firebaseapp.com",
  projectId:"sarmad-web"
});

const auth=firebase.auth();
const db=firebase.firestore();

function sendOTP(){
  window.recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptcha',{size:'invisible'});
  auth.signInWithPhoneNumber(phone.value,recaptchaVerifier).then(r=>{
    window.confirmationResult=r;
    otp.style.display='block';
    vbtn.style.display='block';
  });
}

function verifyOTP(){
  confirmationResult.confirm(otp.value).then(()=>location.reload());
}

auth.onAuthStateChanged(u=>{
  if(!u) return;
  authDiv.style.display='none';
  main.style.display='block';

  db.collection('investors').doc(u.phoneNumber)
  .onSnapshot(d=>bal.innerText=d.data()?.balance||0);

  db.collection('purchase_requests')
  .where('investorPhone','==',u.phoneNumber)
  .onSnapshot(s=>{
    hist.innerHTML='';
    s.forEach(d=>{
      hist.innerHTML+=`<tr><td>${d.data().txid}</td><td>${d.data().status}</td></tr>`;
    });
  });
});

async function sendReq(){
  const t=txid.value.trim();
  if(!t) return;

  const lock=db.collection('txids').doc(t);
  if((await lock.get()).exists) return alert('TXID مستخدم');

  await lock.set({used:true});
  await db.collection('purchase_requests').add({
    investorPhone:auth.currentUser.phoneNumber,
    txid:t,
    status:'pending',
    createdAt:new Date()
  });

  txid.value='';
}
</script>
</body>
</html>
